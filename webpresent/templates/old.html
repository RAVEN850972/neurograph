<!DOCTYPE html>
<html lang="ru">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>NeuroGraph Assistant</title>
   <style>
       * {
           margin: 0;
           padding: 0;
           box-sizing: border-box;
       }

       body {
           font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
           background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
           min-height: 100vh;
           display: flex;
           justify-content: center;
           align-items: center;
           padding: 20px;
       }

       .container {
           background: rgba(255, 255, 255, 0.95);
           backdrop-filter: blur(20px);
           border-radius: 24px;
           box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
           width: 100%;
           max-width: 1000px;
           height: 85vh;
           display: flex;
           flex-direction: column;
           overflow: hidden;
           border: 1px solid rgba(255, 255, 255, 0.2);
       }

       .header {
           background: linear-gradient(135deg, #4f46e5, #7c3aed);
           color: white;
           padding: 20px 24px;
           display: flex;
           align-items: center;
           gap: 12px;
       }

       .header h1 {
           font-size: 24px;
           font-weight: 700;
       }

       .brain-icon {
           font-size: 28px;
           animation: pulse 2s infinite;
       }

       @keyframes pulse {
           0%, 100% { transform: scale(1); }
           50% { transform: scale(1.1); }
       }

       .status {
           display: flex;
           align-items: center;
           gap: 8px;
           margin-left: auto;
           font-size: 14px;
       }

       .status-dot {
           width: 8px;
           height: 8px;
           border-radius: 50%;
           background: #10b981;
           animation: blink 1.5s infinite;
       }

       .status-dot.inactive {
           background: #ef4444;
           animation: none;
       }

       @keyframes blink {
           0%, 100% { opacity: 1; }
           50% { opacity: 0.3; }
       }

       .main-content {
           flex: 1;
           display: flex;
           flex-direction: column;
           overflow: hidden;
       }

       .tabs {
           display: flex;
           border-bottom: 1px solid #e5e7eb;
           background: #f9fafb;
       }

       .tab {
           padding: 12px 20px;
           cursor: pointer;
           border: none;
           background: none;
           font-size: 14px;
           font-weight: 500;
           color: #6b7280;
           transition: all 0.2s;
           position: relative;
       }

       .tab.active {
           color: #4f46e5;
           background: white;
       }

       .tab.active::after {
           content: '';
           position: absolute;
           bottom: 0;
           left: 0;
           right: 0;
           height: 2px;
           background: #4f46e5;
       }

       .tab-content {
           flex: 1;
           display: none;
           flex-direction: column;
           overflow: hidden;
       }

       .tab-content.active {
           display: flex;
       }

       .chat-container {
           flex: 1;
           overflow-y: auto;
           padding: 20px;
           display: flex;
           flex-direction: column;
           gap: 16px;
       }

       .message {
           display: flex;
           gap: 12px;
           max-width: 80%;
           animation: slideIn 0.3s ease-out;
       }

       @keyframes slideIn {
           from {
               opacity: 0;
               transform: translateY(10px);
           }
           to {
               opacity: 1;
               transform: translateY(0);
           }
       }

       .message.user {
           align-self: flex-end;
           flex-direction: row-reverse;
       }

       .message.assistant {
           align-self: flex-start;
       }

       .avatar {
           width: 36px;
           height: 36px;
           border-radius: 50%;
           display: flex;
           align-items: center;
           justify-content: center;
           font-weight: bold;
           color: white;
           font-size: 14px;
           flex-shrink: 0;
       }

       .avatar.user {
           background: linear-gradient(135deg, #10b981, #059669);
       }

       .avatar.assistant {
           background: linear-gradient(135deg, #8b5cf6, #7c3aed);
       }

       .message-content {
           background: white;
           border-radius: 18px;
           padding: 12px 16px;
           box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
           border: 1px solid #e5e7eb;
           position: relative;
       }

       .message.user .message-content {
           background: linear-gradient(135deg, #4f46e5, #7c3aed);
           color: white;
           border: none;
       }

       .message-meta {
           font-size: 11px;
           color: #9ca3af;
           margin-top: 4px;
           display: flex;
           align-items: center;
           gap: 8px;
       }

       .confidence-bar {
           width: 40px;
           height: 3px;
           background: #e5e7eb;
           border-radius: 2px;
           overflow: hidden;
       }

       .confidence-fill {
           height: 100%;
           background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
           transition: width 0.3s ease;
       }

       .input-container {
           padding: 20px;
           border-top: 1px solid #e5e7eb;
           background: #f9fafb;
       }

       .input-wrapper {
           position: relative;
           display: flex;
           gap: 12px;
       }

       .message-input {
           flex: 1;
           padding: 12px 16px;
           border: 2px solid #e5e7eb;
           border-radius: 12px;
           font-size: 14px;
           outline: none;
           transition: all 0.2s;
           background: white;
       }

       .message-input:focus {
           border-color: #4f46e5;
           box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
       }

       .send-btn {
           padding: 12px 20px;
           background: linear-gradient(135deg, #4f46e5, #7c3aed);
           color: white;
           border: none;
           border-radius: 12px;
           cursor: pointer;
           font-weight: 600;
           transition: all 0.2s;
           display: flex;
           align-items: center;
           gap: 8px;
       }

       .send-btn:hover {
           transform: translateY(-2px);
           box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
       }

       .send-btn:disabled {
           opacity: 0.6;
           cursor: not-allowed;
           transform: none;
       }

       .knowledge-panel {
           padding: 20px;
           overflow-y: auto;
       }

       .knowledge-stats {
           display: grid;
           grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
           gap: 16px;
           margin-bottom: 24px;
       }

       .stat-card {
           background: white;
           padding: 16px;
           border-radius: 12px;
           border: 1px solid #e5e7eb;
           text-align: center;
       }

       .stat-value {
           font-size: 24px;
           font-weight: 700;
           color: #4f46e5;
       }

       .stat-label {
           font-size: 12px;
           color: #6b7280;
           margin-top: 4px;
       }

       .memory-section {
           margin-bottom: 24px;
       }

       .section-title {
           font-size: 16px;
           font-weight: 600;
           margin-bottom: 12px;
           color: #374151;
       }

       .memory-item {
           background: white;
           padding: 12px 16px;
           border-radius: 8px;
           border: 1px solid #e5e7eb;
           margin-bottom: 8px;
           transition: all 0.2s;
       }

       .memory-item:hover {
           border-color: #4f46e5;
           transform: translateX(4px);
       }

       .memory-content {
           font-size: 14px;
           margin-bottom: 4px;
       }

       .memory-tags {
           display: flex;
           gap: 6px;
           flex-wrap: wrap;
       }

       .tag {
           background: #ede9fe;
           color: #7c3aed;
           padding: 2px 8px;
           border-radius: 12px;
           font-size: 11px;
           font-weight: 500;
       }

       .system-panel {
           padding: 20px;
           overflow-y: auto;
       }

       .health-grid {
           display: grid;
           grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
           gap: 16px;
           margin-bottom: 24px;
       }

       .health-card {
           background: white;
           padding: 16px;
           border-radius: 12px;
           border: 1px solid #e5e7eb;
       }

       .health-header {
           display: flex;
           align-items: center;
           justify-content: space-between;
           margin-bottom: 8px;
       }

       .health-status {
           width: 8px;
           height: 8px;
           border-radius: 50%;
           background: #10b981;
       }

       .health-status.warning {
           background: #f59e0b;
       }

       .health-status.error {
           background: #ef4444;
       }

       .performance-chart {
           height: 60px;
           background: linear-gradient(135deg, #f0f9ff, #e0e7ff);
           border-radius: 8px;
           display: flex;
           align-items: end;
           padding: 8px;
           gap: 2px;
       }

       .chart-bar {
           flex: 1;
           background: linear-gradient(to top, #4f46e5, #7c3aed);
           border-radius: 2px;
           transition: height 0.3s ease;
       }

       .loading {
           display: inline-flex;
           align-items: center;
           gap: 4px;
       }

       .loading-dot {
           width: 4px;
           height: 4px;
           border-radius: 50%;
           background: currentColor;
           animation: loadingPulse 1.4s infinite ease-in-out;
       }

       .loading-dot:nth-child(1) { animation-delay: -0.32s; }
       .loading-dot:nth-child(2) { animation-delay: -0.16s; }

       @keyframes loadingPulse {
           0%, 80%, 100% { opacity: 0.3; }
           40% { opacity: 1; }
       }

       .thinking {
           font-style: italic;
           color: #6b7280;
           display: flex;
           align-items: center;
           gap: 8px;
       }

       .error-message {
           background: #fee2e2 !important;
           border: 1px solid #fecaca !important;
           color: #dc2626 !important;
       }

       .connection-status {
           position: fixed;
           top: 20px;
           right: 20px;
           padding: 8px 12px;
           border-radius: 8px;
           font-size: 12px;
           font-weight: 500;
           z-index: 1000;
           transition: all 0.3s;
       }

       .connection-status.connected {
           background: #d1fae5;
           color: #065f46;
           border: 1px solid #a7f3d0;
       }

       .connection-status.disconnected {
           background: #fee2e2;
           color: #dc2626;
           border: 1px solid #fecaca;
       }
   </style>
</head>
<body>
   <div class="connection-status connected" id="connection-status">
       🟢 Подключено
   </div>

   <div class="container">
       <div class="header">
           <div class="brain-icon">🧠</div>
           <h1>NeuroGraph Assistant</h1>
           <div class="status">
               <div class="status-dot" id="system-status-dot"></div>
               <span id="system-status-text">Загрузка...</span>
           </div>
       </div>

       <div class="main-content">
           <div class="tabs">
               <button class="tab active" onclick="switchTab('chat')">💬 Чат</button>
               <button class="tab" onclick="switchTab('knowledge')">📚 Знания</button>
               <button class="tab" onclick="switchTab('system')">⚙️ Система</button>
           </div>

           <div class="tab-content active" id="chat-tab">
               <div class="chat-container" id="chat-container">
                   <!-- Сообщения будут добавляться динамически -->
               </div>

               <div class="input-container">
                   <div class="input-wrapper">
                       <input type="text" class="message-input" id="message-input" 
                              placeholder="Напишите сообщение..." 
                              onkeypress="handleKeyPress(event)">
                       <button class="send-btn" id="send-btn" onclick="sendMessage()">
                           <span>Отправить</span>
                           <span>🚀</span>
                       </button>
                   </div>
               </div>
           </div>

           <div class="tab-content" id="knowledge-tab">
               <div class="knowledge-panel">
                   <div class="knowledge-stats">
                       <div class="stat-card">
                           <div class="stat-value" id="total-knowledge">0</div>
                           <div class="stat-label">Знаний</div>
                       </div>
                       <div class="stat-card">
                           <div class="stat-value" id="active-memories">0</div>
                           <div class="stat-label">Активных воспоминаний</div>
                       </div>
                       <div class="stat-card">
                           <div class="stat-value" id="graph-nodes">0</div>
                           <div class="stat-label">Узлов в графе</div>
                       </div>
                       <div class="stat-card">
                           <div class="stat-value" id="connections">0</div>
                           <div class="stat-label">Связей</div>
                       </div>
                   </div>

                   <div class="memory-section">
                       <div class="section-title">🧠 Кратковременная память</div>
                       <div id="stm-items">
                           <div class="memory-item">
                               <div class="memory-content">Пока пусто... Начните беседу!</div>
                               <div class="memory-tags">
                                   <span class="tag">система</span>
                               </div>
                           </div>
                       </div>
                   </div>

                   <div class="memory-section">
                       <div class="section-title">💾 Долговременная память</div>
                       <div id="ltm-items">
                           <div class="memory-item">
                               <div class="memory-content">Пока пусто... Расскажите мне что-нибудь!</div>
                               <div class="memory-tags">
                                   <span class="tag">система</span>
                               </div>
                           </div>
                       </div>
                   </div>

                   <div class="memory-section">
                       <div class="section-title">📝 Локальные знания сессии</div>
                       <div id="local-knowledge">
                           <div class="memory-item">
                               <div class="memory-content">Попросите меня что-то запомнить!</div>
                               <div class="memory-tags">
                                   <span class="tag">локально</span>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>
           </div>

           <div class="tab-content" id="system-tab">
               <div class="system-panel">
                   <div class="health-grid">
                       <div class="health-card">
                           <div class="health-header">
                               <span>NLP Модуль</span>
                               <div class="health-status" id="nlp-status"></div>
                           </div>
                           <div>Обработка языка</div>
                           <div class="performance-chart" id="nlp-chart">
                               <div class="chart-bar" style="height: 70%"></div>
                               <div class="chart-bar" style="height: 85%"></div>
                               <div class="chart-bar" style="height: 60%"></div>
                               <div class="chart-bar" style="height: 90%"></div>
                               <div class="chart-bar" style="height: 75%"></div>
                           </div>
                       </div>

                       <div class="health-card">
                           <div class="health-header">
                               <span>SemGraph</span>
                               <div class="health-status" id="graph-status"></div>
                           </div>
                           <div>Граф знаний</div>
                           <div class="performance-chart" id="graph-chart">
                               <div class="chart-bar" style="height: 80%"></div>
                               <div class="chart-bar" style="height: 65%"></div>
                               <div class="chart-bar" style="height: 95%"></div>
                               <div class="chart-bar" style="height: 70%"></div>
                               <div class="chart-bar" style="height: 88%"></div>
                           </div>
                       </div>

                       <div class="health-card">
                           <div class="health-header">
                               <span>Memory</span>
                               <div class="health-status" id="memory-status"></div>
                           </div>
                           <div>Система памяти</div>
                           <div class="performance-chart" id="memory-chart">
                               <div class="chart-bar" style="height: 55%"></div>
                               <div class="chart-bar" style="height: 75%"></div>
                               <div class="chart-bar" style="height: 65%"></div>
                               <div class="chart-bar" style="height: 80%"></div>
                               <div class="chart-bar" style="height: 70%"></div>
                           </div>
                       </div>

                       <div class="health-card">
                           <div class="health-header">
                               <span>Processor</span>
                               <div class="health-status" id="processor-status"></div>
                           </div>
                           <div>Логический вывод</div>
                           <div class="performance-chart" id="processor-chart">
                               <div class="chart-bar" style="height: 90%"></div>
                               <div class="chart-bar" style="height: 75%"></div>
                               <div class="chart-bar" style="height: 85%"></div>
                               <div class="chart-bar" style="height: 60%"></div>
                               <div class="chart-bar" style="height: 95%"></div>
                           </div>
                       </div>
                   </div>

                   <div class="memory-section">
                       <div class="section-title">📊 Системная статистика</div>
                       <div class="knowledge-stats">
                           <div class="stat-card">
                               <div class="stat-value" id="uptime">0:00:00</div>
                               <div class="stat-label">Время работы</div>
                           </div>
                           <div class="stat-card">
                               <div class="stat-value" id="total-users">0</div>
                               <div class="stat-label">Пользователей</div>
                           </div>
                           <div class="stat-card">
                               <div class="stat-value" id="total-messages">0</div>
                               <div class="stat-label">Сообщений</div>
                           </div>
                           <div class="stat-card">
                               <div class="stat-value" id="system-health">Загрузка</div>
                               <div class="stat-label">Статус системы</div>
                           </div>
                       </div>
                   </div>

                   <div class="memory-section" id="neurograph-memory-section" style="display: none;">
                       <div class="section-title">🧠 NeuroGraph память</div>
                       <div class="knowledge-stats">
                           <div class="stat-card">
                               <div class="stat-value" id="ng-stm-size">0</div>
                               <div class="stat-label">STM элементов</div>
                           </div>
                           <div class="stat-card">
                               <div class="stat-value" id="ng-ltm-size">0</div>
                               <div class="stat-label">LTM элементов</div>
                           </div>
                           <div class="stat-card">
                               <div class="stat-value" id="ng-total-items">0</div>
                               <div class="stat-label">Всего элементов</div>
                           </div>
                           <div class="stat-card">
                               <div class="stat-value" id="ng-consolidations">0</div>
                               <div class="stat-label">Консолидаций</div>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <script>
       // Глобальные переменные
       let sessionId = localStorage.getItem('neurograph_session_id') || generateSessionId();
       let isProcessing = false;
       let connectionStatus = true;

       // Сохраняем session ID
       localStorage.setItem('neurograph_session_id', sessionId);

       function generateSessionId() {
           return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
       }

       // API функции
       async function apiRequest(endpoint, options = {}) {
           try {
               const response = await fetch(endpoint, {
                   headers: {
                       'Content-Type': 'application/json',
                       ...options.headers
                   },
                   ...options
               });
               
               if (!response.ok) {
                   throw new Error(`HTTP ${response.status}: ${response.statusText}`);
               }
               
               updateConnectionStatus(true);
               return await response.json();
           } catch (error) {
               console.error('API request failed:', error);
               updateConnectionStatus(false);
               throw error;
           }
       }

       function updateConnectionStatus(connected) {
           connectionStatus = connected;
           const statusElement = document.getElementById('connection-status');
           const statusDot = document.getElementById('system-status-dot');
           const statusText = document.getElementById('system-status-text');
           
           if (connected) {
               statusElement.className = 'connection-status connected';
               statusElement.textContent = '🟢 Подключено';
               statusDot.className = 'status-dot';
               statusText.textContent = 'Активен';
           } else {
               statusElement.className = 'connection-status disconnected';
               statusElement.textContent = '🔴 Нет связи';
               statusDot.className = 'status-dot inactive';
               statusText.textContent = 'Недоступен';
           }
       }

       // Переключение вкладок
       function switchTab(tabName) {
           document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
           document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
           
           event.target.classList.add('active');
           document.getElementById(tabName + '-tab').classList.add('active');
           
           if (tabName === 'knowledge') {
               updateKnowledgePanel();
           } else if (tabName === 'system') {
               updateSystemPanel();
           }
       }

       // Отправка сообщения
       async function sendMessage() {
           const input = document.getElementById('message-input');
           const message = input.value.trim();
           
           if (!message || isProcessing) return;
           
           input.value = '';
           isProcessing = true;
           updateSendButton(true);
           
           try {
               // Показываем индикатор "печатает"
               const thinkingId = addThinkingIndicator();
               
               // Отправляем запрос к API
               const response = await apiRequest('/api/message', {
                   method: 'POST',
                   body: JSON.stringify({
                       message: message,
                       session_id: sessionId
                   })
               });
               
               // Убираем индикатор "печатает"
               removeThinkingIndicator(thinkingId);
               
               if (response.success) {
                   // Добавляем сообщение пользователя
                   addMessageToChat('user', message, 1.0);
                   
                   // Добавляем ответ ассистента
                   const assistantMsg = response.message;
                   addMessageToChat('assistant', assistantMsg.content, assistantMsg.confidence, {
                       sources: assistantMsg.sources,
                       processingTime: assistantMsg.processing_time,
                       isError: assistantMsg.error
                   });
               } else {
                   addMessageToChat('assistant', response.message.content, 0.1, { isError: true });
               }
               
           } catch (error) {
               removeThinkingIndicator();
               addMessageToChat('assistant', 
                   'Извините, произошла ошибка соединения с сервером. Проверьте подключение к интернету.', 
                   0.1, { isError: true }
               );
           }
           
           isProcessing = false;
           updateSendButton(false);
           input.focus();
       }

       function addMessageToChat(sender, content, confidence, meta = {}) {
           const chatContainer = document.getElementById('chat-container');
           const messageDiv = document.createElement('div');
           messageDiv.className = `message ${sender}`;
           
           const avatar = sender === 'user' ? '👤' : '🤖';
           const time = new Date().toLocaleTimeString('ru-RU', { 
               hour: '2-digit', 
               minute: '2-digit' 
           });
           
           let metaInfo = `<span>${time}</span>`;
           if (confidence !== undefined) {
               metaInfo += `
                   <div class="confidence-bar">
                       <div class="confidence-fill" style="width: ${confidence * 100}%"></div>
                   </div>
                   <span>${Math.round(confidence * 100)}%</span>
               `;
           }
           
           if (meta.processingTime) {
               metaInfo += `<span>${Math.round(meta.processingTime)}ms</span>`;
           }
           
           const contentClass = meta.isError ? 'error-message' : '';
           
           messageDiv.innerHTML = `
               <div class="avatar ${sender}">${avatar}</div>
               <div class="message-content ${contentClass}">
                   <div>${formatMessageContent(content)}</div>
                   <div class="message-meta">${metaInfo}</div>
               </div>
           `;
           
           chatContainer.appendChild(messageDiv);
           chatContainer.scrollTop = chatContainer.scrollHeight;
       }

       function formatMessageContent(content) {
           // Простое форматирование markdown-подобного текста
           return content
               .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
               .replace(/\*(.*?)\*/g, '<em>$1</em>')
               .replace(/\n/g, '<br>');
       }

       function addThinkingIndicator() {
           const chatContainer = document.getElementById('chat-container');
           const thinkingDiv = document.createElement('div');
           const thinkingId = 'thinking-' + Date.now();
           thinkingDiv.id = thinkingId;
           thinkingDiv.className = 'message assistant';
           
           thinkingDiv.innerHTML = `
               <div class="avatar assistant">🤖</div>
               <div class="message-content">
                   <div class="thinking">
                       <span>Анализирую запрос</span>
                       <div class="loading">
                           <div class="loading-dot"></div>
                           <div class="loading-dot"></div>
                           <div class="loading-dot"></div>
                       </div>
                   </div>
               </div>
           `;
           
           chatContainer.appendChild(thinkingDiv);
           chatContainer.scrollTop = chatContainer.scrollHeight;
           
           return thinkingId;
       }

       function removeThinkingIndicator(thinkingId) {
           if (thinkingId) {
               const thinkingDiv = document.getElementById(thinkingId);
               if (thinkingDiv) {
                   thinkingDiv.remove();
               }
           } else {
               // Удаляем все индикаторы "думает"
               document.querySelectorAll('[id^="thinking-"]').forEach(el => el.remove());
           }
       }

       function updateSendButton(disabled) {
           const sendBtn = document.getElementById('send-btn');
           sendBtn.disabled = disabled;
           
           if (disabled) {
               sendBtn.innerHTML = `
                   <div class="loading">
                       <div class="loading-dot"></div>
                       <div class="loading-dot"></div>
                       <div class="loading-dot"></div>
                   </div>
               `;
           } else {
               sendBtn.innerHTML = `
                   <span>Отправить</span>
                   <span>🚀</span>
               `;
           }
       }

       function handleKeyPress(event) {
           if (event.key === 'Enter' && !event.shiftKey) {
               event.preventDefault();
               sendMessage();
           }
       }

       // Обновление панели знаний
       async function updateKnowledgePanel() {
           try {
               const knowledge = await apiRequest(`/api/knowledge/${sessionId}`);
               
               // Обновляем статистику
               document.getElementById('total-knowledge').textContent = knowledge.stats.total_knowledge;
               document.getElementById('active-memories').textContent = knowledge.stats.active_memories;
               document.getElementById('graph-nodes').textContent = knowledge.stats.graph_nodes;
               document.getElementById('connections').textContent = knowledge.stats.connections;
               
               // Обновляем STM
               updateMemorySection('stm-items', knowledge.stm_items);
               
               // Обновляем LTM
               updateMemorySection('ltm-items', knowledge.ltm_items);
               
               // Обновляем локальные знания
               updateLocalKnowledge(knowledge.local_knowledge);
               
           } catch (error) {
               console.error('Ошибка обновления панели знаний:', error);
           }
       }

       function updateMemorySection(containerId, items) {
           const container = document.getElementById(containerId);
           container.innerHTML = '';
           
           if (!items || items.length === 0) {
               container.innerHTML = `
                   <div class="memory-item">
                       <div class="memory-content">Пока пусто...</div>
                       <div class="memory-tags">
                           <span class="tag">система</span>
                       </div>
                   </div>
               `;
               return;
           }
           
           items.forEach(item => {
               const itemDiv = document.createElement('div');
               itemDiv.className = 'memory-item';
               itemDiv.innerHTML = `
                   <div class="memory-content">${item.content}</div>
                   <div class="memory-tags">
                       ${(item.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                   </div>
               `;
               container.appendChild(itemDiv);
           });
       }

       function updateLocalKnowledge(localKnowledge) {
           const container = document.getElementById('local-knowledge');
           container.innerHTML = '';
           
           if (!localKnowledge || Object.keys(localKnowledge).length === 0) {
               container.innerHTML = `
                   <div class="memory-item">
                       <div class="memory-content">Попросите меня что-то запомнить!</div>
                       <div class="memory-tags">
                           <span class="tag">локально</span>
                       </div>
                   </div>
               `;
               return;
           }
           
           Object.values(localKnowledge).forEach(item => {
               const itemDiv = document.createElement('div');
               itemDiv.className = 'memory-item';
               itemDiv.innerHTML = `
                   <div class="memory-content">${item.content}</div>
                   <div class="memory-tags">
                       <span class="tag">${item.category}</span>
                       <span class="tag">локально</span>
                   </div>
               `;
               container.appendChild(itemDiv);
           });
       }

       // Обновление системной панели
       async function updateSystemPanel() {
           try {
               const systemData = await apiRequest('/api/system');
               
               // Обновляем статусы компонентов
               updateComponentStatus('nlp-status', systemData.components.nlp.status);
               updateComponentStatus('graph-status', systemData.components.semgraph.status);
               updateComponentStatus('memory-status', systemData.components.memory.status);
               updateComponentStatus('processor-status', systemData.components.processor.status);
               
               // Обновляем системную статистику
               document.getElementById('uptime').textContent = systemData.stats.uptime;
               document.getElementById('total-users').textContent = systemData.stats.total_users;
               document.getElementById('total-messages').textContent = systemData.stats.total_messages;
               document.getElementById('system-health').textContent = systemData.stats.system_health;
               
               // Показываем NeuroGraph память если доступна
               if (systemData.memory_stats && Object.keys(systemData.memory_stats).length > 0) {
                   document.getElementById('neurograph-memory-section').style.display = 'block';
                   updateNeuroGraphMemoryStats(systemData.memory_stats);
               }
               
               // Анимируем графики производительности
               animatePerformanceCharts();
               
           } catch (error) {
               console.error('Ошибка обновления системной панели:', error);
           }
       }

       function updateComponentStatus(elementId, status) {
           const element = document.getElementById(elementId);
           element.className = 'health-status';
           
           if (status === 'active') {
               element.classList.add('');
           } else if (status === 'warning') {
               element.classList.add('warning');
           } else {
               element.classList.add('error');
           }
       }

       function updateNeuroGraphMemoryStats(memoryStats) {
           try {
               const levels = memoryStats.memory_levels;
               if (levels) {
                   document.getElementById('ng-stm-size').textContent = levels.stm?.size || 0;
                   document.getElementById('ng-ltm-size').textContent = levels.ltm?.size || 0;
               }
               
               document.getElementById('ng-total-items').textContent = memoryStats.total_items || 0;
               
               const consolidation = memoryStats.consolidation?.consolidation;
               if (consolidation) {
                   document.getElementById('ng-consolidations').textContent = consolidation.total_consolidated || 0;
               }
           } catch (error) {
               console.error('Ошибка обновления статистики NeuroGraph памяти:', error);
           }
       }

       function animatePerformanceCharts() {
           const charts = document.querySelectorAll('.performance-chart');
           
           charts.forEach(chart => {
               const bars = chart.querySelectorAll('.chart-bar');
               bars.forEach(bar => {
                   const newHeight = Math.random() * 40 + 40; // 40-80%
                   bar.style.height = `${newHeight}%`;
               });
           });
       }

       // Инициализация при загрузке страницы
       document.addEventListener('DOMContentLoaded', function() {
           console.log('🚀 Инициализация NeuroGraph Web Assistant');
           console.log('Session ID:', sessionId);
           
           // Фокус на поле ввода
           document.getElementById('message-input').focus();
           
           // Проверяем подключение к серверу
           checkServerConnection();
           
           // Загружаем историю сообщений если есть
           loadChatHistory();
           
           // Периодическое обновление системных метрик
           setInterval(() => {
               if (document.getElementById('system-tab').classList.contains('active')) {
                   updateSystemPanel();
               }
           }, 5000);
           
           // Периодическая проверка соединения
           setInterval(checkServerConnection, 30000);
       });

       async function checkServerConnection() {
           try {
               await apiRequest('/api/health');
               updateConnectionStatus(true);
           } catch (error) {
               updateConnectionStatus(false);
           }
       }

       async function loadChatHistory() {
           try {
               const sessionData = await apiRequest(`/api/sessions/${sessionId}`);
               
               if (sessionData.messages && sessionData.messages.length > 0) {
                   // Очищаем контейнер чата
                   const chatContainer = document.getElementById('chat-container');
                   chatContainer.innerHTML = '';
                   
                   // Добавляем сообщения из истории
                   sessionData.messages.forEach(msg => {
                       addMessageToChat(msg.sender, msg.content, msg.confidence, {
                           sources: msg.sources,
                           processingTime: msg.processing_time,
                           isError: msg.error
                       });
                   });
               } else {
                   // Добавляем приветственное сообщение
                   addWelcomeMessage();
               }
               
           } catch (error) {
               console.error('Ошибка загрузки истории чата:', error);
               addWelcomeMessage();
           }
       }

       function addWelcomeMessage() {
           addMessageToChat('assistant', 
               'Привет! Я NeuroGraph Assistant - ваш персональный ИИ-помощник с биоморфной архитектурой памяти. Я могу обучаться, запоминать информацию и помогать решать задачи. О чем хотите поговорить?', 
               0.95, { sources: ['система'] }
           );
       }

       // Дополнительные функции для демонстрации возможностей
       function showDemoCommands() {
           const demoMessages = [
               "Попробуйте команды:",
               "• 'Запомни: [факт]' - для обучения",
               "• 'Покажи память' - для просмотра памяти", 
               "• 'Статус системы' - для диагностики",
               "• 'Что ты умеешь?' - для справки"
           ];
           
           addMessageToChat('assistant', demoMessages.join('\n'), 0.9, { sources: ['помощь'] });
       }

       // Горячие клавиши
       document.addEventListener('keydown', function(event) {
           // Ctrl/Cmd + Enter для отправки сообщения
           if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
               sendMessage();
           }
           
           // Ctrl/Cmd + K для очистки чата
           if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
               event.preventDefault();
               clearChat();
           }
           
           // Ctrl/Cmd + 1,2,3 для переключения вкладок
           if ((event.ctrlKey || event.metaKey) && ['1', '2', '3'].includes(event.key)) {
               event.preventDefault();
               const tabs = ['chat', 'knowledge', 'system'];
               const tabIndex = parseInt(event.key) - 1;
               if (tabs[tabIndex]) {
                   switchTabByName(tabs[tabIndex]);
               }
           }
       });

       function switchTabByName(tabName) {
           // Находим соответствующую кнопку вкладки
           const tabs = document.querySelectorAll('.tab');
           tabs.forEach((tab, index) => {
               const tabNames = ['chat', 'knowledge', 'system'];
               if (tabNames[index] === tabName) {
                   tab.click();
               }
           });
       }

       function clearChat() {
           if (confirm('Очистить историю чата? Это действие нельзя отменить.')) {
               const chatContainer = document.getElementById('chat-container');
               chatContainer.innerHTML = '';
               
               // Создаем новую сессию
               sessionId = generateSessionId();
               localStorage.setItem('neurograph_session_id', sessionId);
               
               // Добавляем приветственное сообщение
               addWelcomeMessage();
               
               console.log('Чат очищен, новая сессия:', sessionId);
           }
       }

       // Экспорт данных сессии
       async function exportSessionData() {
           try {
               const sessionData = await apiRequest(`/api/sessions/${sessionId}`);
               const knowledgeData = await apiRequest(`/api/knowledge/${sessionId}`);
               
               const exportData = {
                   sessionId: sessionId,
                   exportDate: new Date().toISOString(),
                   messages: sessionData.messages,
                   knowledge: knowledgeData,
                   sessionStats: sessionData.session
               };
               
               // Создаем и скачиваем файл
               const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                   type: 'application/json' 
               });
               const url = URL.createObjectURL(blob);
               const a = document.createElement('a');
               a.href = url;
               a.download = `neurograph_session_${sessionId}_${new Date().toISOString().split('T')[0]}.json`;
               document.body.appendChild(a);
               a.click();
               document.body.removeChild(a);
               URL.revokeObjectURL(url);
               
               addMessageToChat('assistant', 
                   '📁 Данные сессии экспортированы! Файл сохранен в папку загрузок.', 
                   0.95, { sources: ['система'] }
               );
               
           } catch (error) {
               console.error('Ошибка экспорта данных:', error);
               addMessageToChat('assistant', 
                   '❌ Ошибка при экспорте данных сессии.', 
                   0.1, { isError: true }
               );
           }
       }

       // Добавляем контекстное меню для дополнительных функций
       document.addEventListener('contextmenu', function(event) {
           if (event.target.closest('.chat-container')) {
               event.preventDefault();
               showContextMenu(event.pageX, event.pageY);
           }
       });

       function showContextMenu(x, y) {
           // Удаляем существующее меню если есть
           const existingMenu = document.getElementById('context-menu');
           if (existingMenu) {
               existingMenu.remove();
           }
           
           const menu = document.createElement('div');
           menu.id = 'context-menu';
           menu.style.cssText = `
               position: fixed;
               top: ${y}px;
               left: ${x}px;
               background: white;
               border: 1px solid #e5e7eb;
               border-radius: 8px;
               box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
               padding: 8px 0;
               z-index: 1000;
               min-width: 180px;
           `;
           
           const menuItems = [
               { text: '🗑️ Очистить чат', action: clearChat },
               { text: '📁 Экспорт данных', action: exportSessionData },
               { text: '🔄 Обновить', action: () => location.reload() },
               { text: '❓ Показать команды', action: showDemoCommands }
           ];
           
           menuItems.forEach(item => {
               const menuItem = document.createElement('div');
               menuItem.style.cssText = `
                   padding: 8px 16px;
                   cursor: pointer;
                   font-size: 14px;
                   transition: background-color 0.2s;
               `;
               menuItem.textContent = item.text;
               menuItem.onmouseover = () => menuItem.style.backgroundColor = '#f3f4f6';
               menuItem.onmouseout = () => menuItem.style.backgroundColor = '';
               menuItem.onclick = () => {
                   item.action();
                   menu.remove();
               };
               menu.appendChild(menuItem);
           });
           
           document.body.appendChild(menu);
           
           // Удаляем меню при клике вне его
           setTimeout(() => {
               document.addEventListener('click', function removeMenu() {
                   menu.remove();
                   document.removeEventListener('click', removeMenu);
               }, 100);
           });
       }

       // Обработка ошибок JavaScript
       window.addEventListener('error', function(event) {
           console.error('JavaScript error:', event.error);
           
           // Показываем ошибку пользователю только для критических ошибок
           if (event.error && event.error.name !== 'AbortError') {
               addMessageToChat('assistant', 
                   '⚠️ Произошла техническая ошибка в интерфейсе. Попробуйте обновить страницу.', 
                   0.1, { isError: true }
               );
           }
       });

       // Показ статуса загрузки
       function showLoadingState() {
           const statusText = document.getElementById('system-status-text');
           statusText.textContent = 'Загружается...';
           
           setTimeout(() => {
               if (connectionStatus) {
                   statusText.textContent = 'Активен';
               } else {
                   statusText.textContent = 'Недоступен';
               }
           }, 2000);
       }

       // Инициализация статуса загрузки
       showLoadingState();

       console.log('✅ NeuroGraph Web Assistant готов к работе!');
       console.log('💡 Доступные горячие клавиши:');
       console.log('   Ctrl+Enter - отправить сообщение');
       console.log('   Ctrl+K - очистить чат');
       console.log('   Ctrl+1/2/3 - переключение вкладок');
       console.log('   ПКМ в чате - контекстное меню');
   </script>
</body>
</html>